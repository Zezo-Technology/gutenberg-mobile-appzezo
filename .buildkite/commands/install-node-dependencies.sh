#!/bin/bash -eu

PLATFORM=$(uname -s)
ARCHITECTURE=$(uname -m)
NODE_VERSION=$(node --version)
PACKAGE_HASH=$(hash_file package-lock.json)
GUTENBERG_PACKAGE_HASH=$(hash_file gutenberg/package-lock.json)
JETPACK_PACKAGE_HASH=$(hash_file jetpack/pnpm-lock.yaml)
CACHEKEY="$BUILDKITE_PIPELINE_SLUG-$PLATFORM-$ARCHITECTURE-node$NODE_VERSION-$PACKAGE_HASH-$GUTENBERG_PACKAGE_HASH"

echo "--- :npm: Restore cache if present"
restore_cache "$CACHEKEY"
restore_cache "$JETPACK_PACKAGE_HASH"

echo "--- :npm: Install Node dependencies"
npm ci --unsafe-perm --prefer-offline --no-audit --no-progress "$@"

echo "--- :npm: Save cache if necessary"
# Notice that we don't cache the local node_modules.
# Those get regenerated by npm ci as per Node reccomendations.
# What we are caching is the root npm folder, which stores pacakge downloads so they are available if the package.json resolution demands them.
save_cache "$HOME/.npm" "$CACHEKEY"

OS=$(uname -s)
if [ "$OS" = "Darwin" ]; then
  save_cache "$HOME/Library/pnpm/store/v3" "$JETPACK_PACKAGE_HASH"
elif [ "$OS" = "Linux" ]; then
  save_cache "$HOME/.local/share/pnpm/store/v3" "$JETPACK_PACKAGE_HASH"
else
  echo "Unsupported OS: $OS."
  exit 1
fi
